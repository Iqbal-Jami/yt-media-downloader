<!-- Cyber Grid Background -->
<div class="cyber-grid"></div>

<!-- Floating Particles -->
<div class="particles-container" id="particles-js"></div>

<!-- Main Container -->
<div class="cyber-container">
  
  <!-- Transformer Header -->
  <div class="transformer-header">
    <div class="header-glow"></div>
    <div class="scan-line"></div>
    
    <div class="logo-container">
      <div class="hexagon-wrapper">
        <div class="hexagon">
          <div class="hexagon-inner">
            <svg viewBox="0 0 100 100" class="transformer-icon">
              <polygon points="50,5 95,27.5 95,72.5 50,95 5,72.5 5,27.5" class="hex-shape"/>
              <circle cx="50" cy="50" r="20" class="core-circle"/>
              <line x1="50" y1="30" x2="50" y2="15" class="antenna"/>
              <line x1="35" y1="40" x2="20" y2="30" class="antenna"/>
              <line x1="65" y1="40" x2="80" y2="30" class="antenna"/>
            </svg>
          </div>
        </div>
      </div>
      
      <h1 class="cyber-title">
        <span class="glitch-text" data-text="CYBER TUBE">CYBER TUBE</span>
      </h1>
      <p class="cyber-subtitle">TRANSFORMER EDITION ‚Ä¢ MEDIA EXTRACTION PROTOCOL</p>
    </div>
    
    <!-- View Switcher -->
    <div class="view-switcher">
      <button 
        [class.active]="mainView === 'downloader'"
        (click)="switchView('downloader')"
        class="view-btn"
      >
        <span class="view-icon">‚ö°</span>
        <span>DOWNLOADER</span>
      </button>
      <button 
        [class.active]="mainView === 'history'"
        (click)="switchView('history')"
        class="view-btn"
      >
        <span class="view-icon">üìú</span>
        <span>HISTORY ({{ historyTotal }})</span>
      </button>
    </div>
  </div>

  <!-- Downloader View -->
  <div *ngIf="mainView === 'downloader'">
  
  <!-- Command Input Panel -->
  <div class="command-panel">
    <div class="panel-border"></div>
    <div class="panel-header">
      <span class="status-indicator"></span>
      <span class="panel-title">[ INITIALIZATION SEQUENCE ]</span>
    </div>
    
    <div class="input-wrapper">
      <div class="input-decoration left"></div>
      <input 
        type="text" 
        [(ngModel)]="videoUrl"
        (keyup.enter)="fetchVideoInfo()"
        placeholder="‚ñ∂ ENTER TARGET URL COORDINATES..."
        class="cyber-input"
      >
      <div class="input-decoration right"></div>
    </div>
    
    <div class="input-hint">
      <span class="hint-icon">üí°</span>
      <span class="hint-text">Supports: Single videos or regular playlists (not YouTube Mix/Radio)</span>
    </div>
    
    <button 
      (click)="fetchVideoInfo()" 
      [disabled]="isLoading"
      class="cyber-button"
      [class.pulse]="!isLoading"
    >
      <span class="button-corners"></span>
      <span class="button-text">
        {{ isLoading ? '‚ü≥ SCANNING MATRIX...' : '‚ö° INITIATE PROTOCOL' }}
      </span>
      <span class="button-glow"></span>
    </button>
  </div>

  <!-- Holographic Loading -->
  <div *ngIf="isLoading" class="hologram-loader">
    <div class="loader-ring"></div>
    <div class="loader-ring-2"></div>
    <div class="loader-core"></div>
    <div class="loader-text">
      <span class="scanning-text">SCANNING</span>
      <span class="loading-dots">...</span>
    </div>
    <div class="progress-bars">
      <div class="progress-bar"></div>
      <div class="progress-bar"></div>
      <div class="progress-bar"></div>
    </div>
  </div>

  <!-- Error Alert -->
  <div *ngIf="errorMessage" class="cyber-alert">
    <div class="alert-icon">‚ö†</div>
    <div class="alert-content">
      <div class="alert-title">SYSTEM ERROR</div>
      <div class="alert-message">{{ errorMessage }}</div>
    </div>
    <div class="alert-close" (click)="errorMessage = ''">‚úï</div>
  </div>

  <!-- Data Panel -->
  <div *ngIf="videoInfo && !isLoading" class="data-panel">
    
    <!-- Holographic Preview -->
    <div class="holo-preview">
      <div class="preview-frame">
        <div class="frame-corners"></div>
        <div class="preview-glow"></div>
        <img [src]="videoInfo.thumbnail" [alt]="videoInfo.title" class="holo-thumbnail">
        <div class="scan-overlay"></div>
      </div>
      
      <div class="data-readout">
        <h3 class="data-title">{{ videoInfo.title }}</h3>
        <div class="data-stats">
          <div class="stat-item">
            <span class="stat-icon">‚è±</span>
            <span class="stat-value">{{ getFormattedDuration() }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-icon">üë§</span>
            <span class="stat-value">{{ videoInfo.author }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Download Terminal -->
    <div class="download-terminal">
      <div class="terminal-header">
        <div class="terminal-buttons">
          <span class="term-btn red"></span>
          <span class="term-btn yellow"></span>
          <span class="term-btn green"></span>
        </div>
        <span class="terminal-title">[ EXTRACTION PROTOCOLS ]</span>
      </div>
      
      <!-- Mode Selector -->
      <div class="mode-selector">
        <button 
          [class.active]="activeTab === 'video'"
          (click)="setActiveTab('video')"
          class="mode-btn"
        >
          <span class="mode-icon">‚ñ∂</span>
          <span>VIDEO MODE</span>
        </button>
        <div class="mode-divider"></div>
        <button 
          [class.active]="activeTab === 'audio'"
          (click)="setActiveTab('audio')"
          class="mode-btn"
        >
          <span class="mode-icon">‚ô™</span>
          <span>AUDIO MODE</span>
        </button>
      </div>

      <!-- Format Grid -->
      <div class="format-grid">
        <!-- Video Formats -->
        <div *ngIf="activeTab === 'video'" class="format-container">
          <div *ngFor="let format of videoFormats; let i = index; trackBy: trackByFormatQuality" 
               class="format-card"
               [style.animation-delay]="i * 0.1 + 's'">
            <div class="card-glow"></div>
            <div class="format-header">
              <div class="quality-badge">{{ format.label }}</div>
              <div class="format-badge">{{ format.ext.toUpperCase() }}</div>
            </div>
            <div class="format-specs">
              {{ format.quality }} ‚Ä¢ {{ format.format.toUpperCase() }}
            </div>
            <div class="format-size">EST: {{ format.size }}</div>
            <button 
              (click)="downloadVideo(format)"
              [disabled]="isDownloading(format)"
              class="extract-btn"
            >
              <span class="btn-icon">{{ isDownloading(format) ? '‚ü≥' : '‚¨á' }}</span>
              <span class="btn-text">
                {{ isDownloading(format) ? 'PROCESSING ' + getDownloadProgress(format).toFixed(0) + '%' : 'EXTRACT' }}
              </span>
            </button>
          </div>
        </div>

        <!-- Audio Formats -->
        <div *ngIf="activeTab === 'audio'" class="format-container">
          <div *ngFor="let format of audioFormats; let i = index; trackBy: trackByFormatQuality" 
               class="format-card"
               [style.animation-delay]="i * 0.1 + 's'">
            <div class="card-glow"></div>
            <div class="format-header">
              <div class="quality-badge">{{ format.label }}</div>
              <div class="format-badge">{{ format.ext.toUpperCase() }}</div>
            </div>
            <div class="format-specs">
              {{ format.quality }} ‚Ä¢ {{ format.format.toUpperCase() }}
            </div>
            <div class="format-size">EST: {{ format.size }}</div>
            <button 
              (click)="downloadVideo(format)"
              [disabled]="isDownloading(format)"
              class="extract-btn"
            >
              <span class="btn-icon">{{ isDownloading(format) ? '‚ü≥' : '‚¨á' }}</span>
              <span class="btn-text">
                {{ isDownloading(format) ? 'PROCESSING ' + getDownloadProgress(format).toFixed(0) + '%' : 'EXTRACT' }}
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Playlist Data Panel -->
  <div *ngIf="playlistInfo && !isLoading && isPlaylist" class="data-panel playlist-panel">
    
    <!-- Playlist Preview -->
    <div class="holo-preview">
      <div class="preview-frame">
        <div class="frame-corners"></div>
        <div class="preview-glow"></div>
        <img [src]="playlistInfo.thumbnail" [alt]="playlistInfo.title" class="holo-thumbnail">
        <div class="scan-overlay"></div>
        <div class="playlist-badge">
          <span class="badge-icon">üìë</span>
          <span class="badge-text">PLAYLIST</span>
        </div>
      </div>
      
      <div class="data-readout">
        <h3 class="data-title">{{ playlistInfo.title }}</h3>
        <div class="data-stats">
          <div class="stat-item">
            <span class="stat-icon">üì∫</span>
            <span class="stat-value">{{ playlistInfo.videoCount }} Videos</span>
          </div>
          <div class="stat-item">
            <span class="stat-icon">üë§</span>
            <span class="stat-value">{{ playlistInfo.author }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Playlist Progress (if downloading) -->
    <div *ngIf="playlistDownloading && playlistProgress" class="playlist-progress-panel">
      <div class="progress-header">
        <h4>Downloading Playlist...</h4>
        <span class="progress-status">{{ playlistProgress.currentVideo }} / {{ playlistProgress.totalVideos }}</span>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar-fill" [style.width.%]="playlistProgress.overallProgress"></div>
      </div>
      <div class="progress-info">
        <span>Current: {{ playlistProgress.currentVideoTitle }}</span>
        <span>{{ playlistProgress.overallProgress.toFixed(0) }}%</span>
      </div>
    </div>

    <!-- Video Selection List -->
    <div class="playlist-videos" *ngIf="!playlistDownloading">
      <div class="videos-header">
        <h4 class="videos-title">[ SELECT VIDEOS TO DOWNLOAD ]</h4>
        <div class="select-all-wrapper">
          <label class="cyber-checkbox">
            <input 
              type="checkbox" 
              [checked]="selectAllPlaylist"
              (change)="toggleSelectAll()"
            >
            <span class="checkbox-mark"></span>
            <span class="checkbox-label">SELECT ALL</span>
          </label>
        </div>
      </div>

      <div class="videos-list">
        <div 
          *ngFor="let video of playlistInfo.videos; let i = index; trackBy: trackByVideoId" 
          class="playlist-video-item"
          [class.selected]="selectedPlaylistVideos.has(video.videoId)"
        >
          <label class="video-checkbox">
            <input 
              type="checkbox" 
              [checked]="selectedPlaylistVideos.has(video.videoId)"
              (change)="togglePlaylistVideo(video.videoId)"
            >
            <span class="checkbox-mark"></span>
          </label>
          
          <div class="video-thumbnail">
            <img [src]="video.thumbnail" [alt]="video.title" loading="lazy">
            <span class="video-index">{{ video.index }}</span>
          </div>
          
          <div class="video-details">
            <h5 class="video-title">{{ video.title }}</h5>
            <div class="video-meta">
              <span class="meta-item">
                <span class="meta-icon">üë§</span>
                {{ video.author }}
              </span>
              <span class="meta-item">
                <span class="meta-icon">‚è±</span>
                {{ formatPlaylistVideoDuration(video.duration) }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Playlist Download Terminal -->
    <div class="download-terminal" *ngIf="!playlistDownloading">
      <div class="terminal-header">
        <div class="terminal-buttons">
          <span class="term-btn red"></span>
          <span class="term-btn yellow"></span>
          <span class="term-btn green"></span>
        </div>
        <span class="terminal-title">[ PLAYLIST EXTRACTION PROTOCOLS ]</span>
      </div>
      
      <!-- Mode Selector -->
      <div class="mode-selector">
        <button 
          [class.active]="activeTab === 'video'"
          (click)="setActiveTab('video')"
          class="mode-btn"
        >
          <span class="mode-icon">‚ñ∂</span>
          <span>VIDEO MODE</span>
        </button>
        <div class="mode-divider"></div>
        <button 
          [class.active]="activeTab === 'audio'"
          (click)="setActiveTab('audio')"
          class="mode-btn"
        >
          <span class="mode-icon">‚ô™</span>
          <span>AUDIO MODE</span>
        </button>
      </div>

      <!-- Format Grid for Playlist -->
      <div class="format-grid">
        <!-- Video Formats -->
        <div *ngIf="activeTab === 'video'" class="format-container">
          <div *ngFor="let format of videoFormats; let i = index; trackBy: trackByFormatQuality" 
               class="format-card"
               [style.animation-delay]="i * 0.1 + 's'">
            <div class="card-glow"></div>
            <div class="format-header">
              <div class="quality-badge">{{ format.label }}</div>
              <div class="format-badge">{{ format.ext.toUpperCase() }}</div>
            </div>
            <div class="format-specs">
              {{ format.quality }} ‚Ä¢ {{ format.format.toUpperCase() }}
            </div>
            <div class="format-info">
              Selected: {{ selectedPlaylistVideos.size }} / {{ playlistInfo.videoCount }}
            </div>
            <button 
              (click)="downloadPlaylist(format)"
              [disabled]="selectedPlaylistVideos.size === 0"
              class="extract-btn"
            >
              <span class="btn-icon">‚¨á</span>
              <span class="btn-text">EXTRACT PLAYLIST</span>
            </button>
          </div>
        </div>

        <!-- Audio Formats -->
        <div *ngIf="activeTab === 'audio'" class="format-container">
          <div *ngFor="let format of audioFormats; let i = index; trackBy: trackByFormatQuality" 
               class="format-card"
               [style.animation-delay]="i * 0.1 + 's'">
            <div class="card-glow"></div>
            <div class="format-header">
              <div class="quality-badge">{{ format.label }}</div>
              <div class="format-badge">{{ format.ext.toUpperCase() }}</div>
            </div>
            <div class="format-specs">
              {{ format.quality }} ‚Ä¢ {{ format.format.toUpperCase() }}
            </div>
            <div class="format-info">
              Selected: {{ selectedPlaylistVideos.size }} / {{ playlistInfo.videoCount }}
            </div>
            <button 
              (click)="downloadPlaylist(format)"
              [disabled]="selectedPlaylistVideos.size === 0"
              class="extract-btn"
            >
              <span class="btn-icon">‚¨á</span>
              <span class="btn-text">EXTRACT PLAYLIST</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cyber Footer -->
  <div class="cyber-footer">
    <div class="footer-line"></div>
    <p class="footer-warning">
      <span class="warning-icon">‚ö†</span>
      LEGAL COMPLIANCE REQUIRED ‚Ä¢ RESPECT DIGITAL RIGHTS MANAGEMENT
    </p>
  </div>
  </div>

  <!-- History View -->
  <div *ngIf="mainView === 'history'" class="history-view">
    <div class="history-header">
      <h2 class="history-title">
        <span class="glitch-text" data-text="DOWNLOAD ARCHIVES">DOWNLOAD ARCHIVES</span>
      </h2>
      <button 
        *ngIf="downloadHistory.length > 0"
        (click)="clearAllHistory()" 
        class="clear-history-btn"
      >
        <span>üóë</span> CLEAR ALL
      </button>
    </div>

    <!-- Loading State -->
    <div *ngIf="historyLoading" class="hologram-loader">
      <div class="loader-ring"></div>
      <div class="loader-ring-2"></div>
      <div class="loader-core"></div>
      <div class="loader-text">
        <span class="scanning-text">LOADING HISTORY</span>
        <span class="loading-dots">...</span>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!historyLoading && downloadHistory.length === 0" class="empty-state">
      <div class="empty-icon">üì≠</div>
      <h3 class="empty-title">NO DOWNLOAD HISTORY</h3>
      <p class="empty-message">Your download history will appear here once you start downloading videos.</p>
      <button (click)="switchView('downloader')" class="cyber-button">
        <span class="button-text">START DOWNLOADING</span>
      </button>
    </div>

    <!-- History List -->
    <div *ngIf="!historyLoading && downloadHistory.length > 0" class="history-list">
      <div *ngFor="let item of downloadHistory; let i = index; trackBy: trackByHistoryId" 
           class="history-item"
           [style.animation-delay]="i * 0.05 + 's'">
        <div class="history-card">
          <div class="card-glow"></div>
          
          <div class="history-thumbnail">
            <img [src]="item.thumbnail" [alt]="item.title" loading="lazy">
            <div class="thumbnail-overlay">
              <span class="format-badge">{{ item.format.toUpperCase() }}</span>
              <span class="quality-badge">{{ item.quality }}</span>
            </div>
          </div>
          
          <div class="history-details">
            <h4 class="history-video-title">{{ item.title }}</h4>
            
            <div class="history-meta">
              <span class="meta-item">
                <span class="meta-icon">üë§</span>
                <span>{{ item.author }}</span>
              </span>
              <span class="meta-item" *ngIf="item.duration">
                <span class="meta-icon">‚è±</span>
                <span>{{ getHistoryDuration(item.duration) }}</span>
              </span>
              <span class="meta-item">
                <span class="meta-icon">üìÖ</span>
                <span>{{ getTimeSince(item.downloadDate) }}</span>
              </span>
            </div>
            
            <div class="history-actions">
              <button 
                (click)="redownloadFromHistory(item)" 
                class="history-action-btn redownload"
                title="Download again"
              >
                <span>‚¨á</span> Re-download
              </button>
              <button 
                (click)="deleteHistoryItem(item.id)" 
                class="history-action-btn delete"
                title="Remove from history"
              >
                <span>üóë</span> Remove
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
